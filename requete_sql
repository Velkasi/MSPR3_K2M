-- Liste des instances d’un client prestataire donné

SELECT
    T_INSTANCE.Adresse_ip_instance,
    T_PERSONNE.Nom,
    T_PERSONNE.Prenom

FROM T_INSTANCE

JOIN TJ_recupere
  ON T_INSTANCE.Id_INSTANCE = TJ_recupere.Id_INSTANCE

JOIN T_PERSONNE
  ON TJ_recupere.Id_Personne = T_PERSONNE.Id_Personne

WHERE T_PERSONNE.Nom = 'Dupont';  -- Remplace par le nom du prestataire

-- Liste des incidents pour une instance donnée


SELECT
    T_INSTANCE.Adresse_ip_instance,
    T_PERSONNE.Nom,
    T_PERSONNE.Prenom,
    TJ_recupere.Id_Date_collecte

FROM TJ_recupere

JOIN T_INSTANCE
  ON TJ_recupere.Id_INSTANCE = T_INSTANCE.Id_INSTANCE

JOIN T_PERSONNE
  ON TJ_recupere.Id_Personne = T_PERSONNE.Id_Personne

WHERE T_INSTANCE.Id_INSTANCE = 1;  -- Remplace par l'ID de l'instance

-- Liste des instances qui n’ont jamais été redémarrées manuellement


SELECT
    Adresse_ip_instance,
    CPU_Client,
    Redemarrage_manuel

FROM T_INSTANCE

WHERE Redemarrage_manuel = FALSE;


-- Instances d’un client prestataire dont le contrat est expiré


SELECT
    T_INSTANCE.Adresse_ip_instance,
    T_CONTRAT.Duree_contrat,
    T_CONTRAT.Id_Date_contrat,
    T_PERSONNE.Nom,
    T_PERSONNE.Prenom,
    TJ_recupere.Id_Date_collecte

FROM T_INSTANCE

JOIN TJ_recupere
  ON T_INSTANCE.Id_INSTANCE = TJ_recupere.Id_INSTANCE

JOIN T_CONTRAT
  ON TJ_recupere.Id_Personne = T_CONTRAT.Id_Personne

JOIN T_PERSONNE
  ON T_CONTRAT.Id_Personne = T_PERSONNE.Id_Personne

WHERE
    T_CONTRAT.Id_Date_contrat +
    CAST(SPLIT_PART(T_CONTRAT.Duree_contrat, ' ', 1) || ' months' AS INTERVAL)
    < CURRENT_DATE;

-- Historique des installations pour une instance donnée


SELECT
    T_INSTANCE.Adresse_ip_instance,
    T_TECHNICIEN.Nom_technicien,
    T_TECHNICIEN.Prenom_technicien,
    T_PERSONNE.Nom,
    T_PERSONNE.Prenom,
    TJ_recupere.Id_Date_collecte

FROM T_INSTANCE

JOIN T_TECHNICIEN
  ON T_INSTANCE.Id_TECHNICIEN = T_TECHNICIEN.Id_TECHNICIEN

JOIN TJ_recupere
  ON T_INSTANCE.Id_INSTANCE = TJ_recupere.Id_INSTANCE

JOIN T_PERSONNE
  ON TJ_recupere.Id_Personne = T_PERSONNE.Id_Personne

WHERE T_INSTANCE.Id_INSTANCE = 1;  -- À adapter
